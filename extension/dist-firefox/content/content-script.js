var a=typeof window.browser<"u"?window.browser:chrome;function T(n,t=0){try{const e=n.parentElement;if(!e)return!1;const o=window.getComputedStyle(e);if(o.display==="none"||o.visibility==="hidden"||o.opacity==="0")return!1;const r=document.createRange();r.selectNodeContents(n);const s=r.getClientRects();if(!s||s.length===0)return!1;for(const i of s)if(!(i.width===0||i.height===0)&&!(i.bottom<-t||i.top>window.innerHeight+t)&&!(i.right<-t||i.left>window.innerWidth+t))return!0}catch{}return!1}function w(){document.querySelectorAll(".dex-viewport").forEach(e=>{e.classList.remove("dex-viewport")});const n=document.getElementById("dex-viewport-start");n&&n.remove();const t=document.getElementById("dex-viewport-end");t&&t.remove(),document.querySelectorAll('[data-marker-type="viewport-start"]').forEach(e=>e.remove()),document.querySelectorAll('[data-marker-type="viewport-end"]').forEach(e=>e.remove())}function C(n=0){var s,i,c;w();let t=null,e=null;const o=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:l=>{var g;const d=(g=l.textContent)==null?void 0:g.trim(),u=l.parentElement;if(u){const E=u.tagName.toLowerCase();if(E==="script"||E==="style"||E==="code"||E==="pre")return NodeFilter.FILTER_REJECT;const m=window.getComputedStyle(u);if(m.display==="none"||m.visibility==="hidden")return NodeFilter.FILTER_REJECT}return d?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}});let r;for(;r=o.nextNode();)if(T(r,n)){const l=r.parentElement;l&&!l.classList.contains("dex-viewport")&&(l.classList.add("dex-viewport"),t||(t=l),e=l)}if(t&&e){const l=document.createElement("div");l.id="dex-viewport-start",l.className="dex-viewport-marker-start",l.style.display="none",l.setAttribute("data-marker-type","viewport-start");const d=document.createElement("div");d.id="dex-viewport-end",d.className="dex-viewport-marker-end",d.style.display="none",d.setAttribute("data-marker-type","viewport-end"),(s=t.parentNode)==null||s.insertBefore(l,t),e.nextSibling?(i=e.parentNode)==null||i.insertBefore(d,e.nextSibling):(c=e.parentNode)==null||c.appendChild(d)}}function _(n){var u,g,E,m,p,S,f,y;const t={},e=(u=document.querySelector('meta[name="description"]'))==null?void 0:u.content;e&&(t.description=e);const o=(g=document.querySelector('meta[name="keywords"]'))==null?void 0:g.content;o&&(t.keywords=o);const r=(E=document.querySelector('meta[name="author"]'))==null?void 0:E.content;r&&(t.author=r);const s=(m=document.querySelector('meta[property="og:title"]'))==null?void 0:m.content;s&&(t.ogTitle=s);const i=(p=document.querySelector('meta[property="og:description"]'))==null?void 0:p.content;i&&(t.ogDescription=i);const c=(S=document.querySelector('meta[property="og:image"]'))==null?void 0:S.content;c&&(t.ogImage=c);const l=(f=document.querySelector('meta[name="twitter:title"]'))==null?void 0:f.content;l&&(t.twitterTitle=l);const d=(y=document.querySelector('meta[name="twitter:description"]'))==null?void 0:y.content;return d&&(t.twitterDescription=d),t}async function h(){const n=window.location.href,t=document.title;console.log("ðŸ“„ [SPEEDY] Extracting content from:",t);try{C()}catch(c){console.error("[content] Error marking viewport elements:",c)}const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:c=>{var E;const l=c.parentElement;if(!l)return NodeFilter.FILTER_REJECT;const d=l.tagName.toLowerCase();if(d==="script"||d==="style"||d==="noscript")return NodeFilter.FILTER_REJECT;const u=window.getComputedStyle(l);return u.display==="none"||u.visibility==="hidden"?NodeFilter.FILTER_REJECT:((E=c.textContent)==null?void 0:E.trim())?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),o=[];let r;for(;r=e.nextNode();)o.push(r.textContent.trim());const s=o.join(" ");try{w()}catch(c){console.error("[content] Error cleaning up viewport markers:",c)}const i={url:n,title:t,content:s,metadata:_()};return console.log("âœ… [SPEEDY] Content extracted:",s.length,"chars"),console.log(`ðŸ“„ [SPEEDY] Extracted content:
`,s),i}function N(n){const t=((n==null?void 0:n.text)||"").trim(),e=(n==null?void 0:n.indexColor)||"#ff9813";if(!t)return!1;A();const o=new Set(["SCRIPT","STYLE","NOSCRIPT","TEXTAREA","MATH"]),r=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode(i){if(!(i.nodeValue||"").trim())return NodeFilter.FILTER_REJECT;let c=i.parentNode;for(;c&&c!==document.body;){if(o.has(c.tagName))return NodeFilter.FILTER_REJECT;c=c.parentNode}return NodeFilter.FILTER_ACCEPT}});let s;for(;s=r.nextNode();){const i=s.nodeValue||"",c=i.toLowerCase().indexOf(t.toLowerCase());if(c!==-1){const l=s.parentElement;if(l){const d=document.createElement("span");d.style.backgroundColor=e,d.style.color="black",d.style.fontWeight="bold";const u=document.createTextNode(i.substring(0,c)),g=document.createTextNode(i.substring(c,c+t.length)),E=document.createTextNode(i.substring(c+t.length));return d.appendChild(g),l.insertBefore(u,s),l.insertBefore(d,s),l.insertBefore(E,s),l.removeChild(s),d.scrollIntoView({behavior:"smooth",block:"center"}),!0}}}return!1}function A(){document.querySelectorAll('span[style*="background"]').forEach(n=>{var t;if(n.style.backgroundColor&&n.style.fontWeight==="bold"){const e=n.textContent,o=document.createTextNode(e);(t=n.parentNode)==null||t.replaceChild(o,n)}})}function b(){console.log("ðŸ”§ [Content] Setting up message handlers..."),a&&a.runtime?(a.runtime.onMessage.addListener((n,t,e)=>(console.log("ðŸ“¨ [Content] ===== MESSAGE RECEIVED ====="),console.log("ðŸ“¨ [Content] Message type:",n.type),console.log("ðŸ“¨ [Content] Full message:",n),console.log("ðŸ“¨ [Content] Sender:",t),P(n,e),!0)),console.log("âœ… [Content] Message listener registered")):console.error("âŒ [Content] browser.runtime not available!")}async function P(n,t){switch(n.type){case"get_page_content":try{const e=await h();t({success:!0,context:e})}catch(e){console.error("âŒ [SPEEDY] get_page_content failed",e),t({success:!1,error:e.message})}break;case"get_selected_text":try{const e=window.getSelection(),o=e?e.toString().trim():"";t({success:!0,text:o})}catch(e){t({success:!1,error:e.message})}break;case"STATE_CHANGED":handleStateChange(n.data),t({success:!0});break;case"toggle-launcher":window.dispatchEvent(new CustomEvent("toggle-launcher")),t({success:!0});break;case"toggle-custom-sidebar":window.dispatchEvent(new CustomEvent("toggle-sidebar-visibility")),t({success:!0});break;case"toggle_overlay":console.log("ðŸŽ¯ [Content] ===== TOGGLE_OVERLAY MATCHED ====="),console.log("ðŸŽ¯ [Content] Forwarding to overlay via window.postMessage"),window.postMessage({type:"SPEEDY_TOGGLE_OVERLAY"},"*"),console.log("âœ… [Content] Message posted to window"),t({success:!0}),console.log("âœ… [Content] Response sent back to background");break;case"insert_text_at_cursor":x(n.text),t({success:!0});break;case"dex-highlight-first-text":try{const{text:e,indexColor:o}=n.payload||{},r=N({text:typeof e=="string"?e:"",indexColor:typeof o=="string"?o:"#ff9813"});t({success:!0,found:r})}catch{t({success:!1,found:!1})}break;case"SCREENSHOT_CAPTURED":console.log("ðŸ“¸ [Content] Screenshot captured, forwarding to overlay"),window.postMessage({type:"SPEEDY_SCREENSHOT_CAPTURED",dataUrl:n.dataUrl,imageData:n.imageData},"*"),t({success:!0});break;default:t({success:!1,error:"Unknown message type"})}}function x(n){const t=document.activeElement;if(t&&"value"in t){const e=t.selectionStart||0,o=t.selectionEnd||0,r=t.value,s=r.substring(0,e)+n+r.substring(o);t.value=s,t.selectionStart=e+n.length,t.selectionEnd=e+n.length}else if(t&&t.isContentEditable){const e=window.getSelection();if(e&&e.rangeCount>0){const o=e.getRangeAt(0);o.deleteContents(),o.insertNode(document.createTextNode(n)),o.collapse(!1)}}}if(window.__SPEEDY_CONTENT_SCRIPT_LOADED__)console.log("âš ï¸ Content script already loaded, skipping re-initialization");else{let t=function(){if(n)return;const e=document.createElement("div");e.id="speedy-ai-overlay-root",document.body.appendChild(e);const o=document.createElement("script");o.src=a.runtime.getURL("overlay/overlay.js"),document.body.appendChild(o),n=!0,console.log("âœ… Overlay injected")};var R=t;window.__SPEEDY_CONTENT_SCRIPT_LOADED__=!0;let n=!1;if(window.addEventListener("message",e=>{if(e.source===window){if(e.data.type==="SPEEDY_OVERLAY_SUBMIT"){const o=e.data.message,r=e.data.selectedTabs||[],s=e.data.model||"anthropic/claude-3.5-sonnet";(async()=>{if(a&&a.storage&&await a.storage.local.set({sharedState:{currentMessage:o,pendingMessage:o,selectedTabs:r,selectedModel:s}}),a&&a.runtime)try{const i=await a.runtime.sendMessage({type:"OPEN_SIDEPANEL_WITH_MESSAGE",message:o,selectedTabs:r,model:s});i&&!i.success&&console.log("Tip: Click the extension icon or press Cmd+B to open the sidepanel")}catch(i){console.error("âŒ [SPEEDY] Failed to send message to background:",i),console.log("Please click the extension icon to open the sidepanel")}})()}if(e.data.type==="SPEEDY_OVERLAY_MESSAGE_CHANGE"){const o=e.data.message;a&&a.storage&&a.storage.local.get(["sharedState"],r=>{const s=r.sharedState||{};s.currentMessage=o,a.storage.local.set({sharedState:s})})}if(e.data.type==="SPEEDY_CONTEXT_CHANGED"){const o=e.data.selectedTabs||[];a&&a.storage&&a.storage.local.get(["sharedState"],r=>{const s=r.sharedState||{};s.selectedTabs=o,a.storage.local.set({sharedState:s})})}if(e.data.type==="SPEEDY_REQUEST_TABS"&&a&&a.runtime&&(async()=>{try{const o=await a.runtime.sendMessage({type:"GET_ALL_TABS"});o&&o.success&&window.postMessage({type:"SPEEDY_TABS_RESPONSE",tabs:o.tabs},"*")}catch(o){console.log("Failed to get tabs:",o.message)}})(),e.data.type==="SPEEDY_API_REQUEST"){const{requestId:o,method:r,endpoint:s,body:i}=e.data;s.includes("/chat")&&i&&(console.log("ðŸ’¬ [SPEEDY] Sending message to AI"),console.log("ðŸ¤– Model:",i.model),i.messages&&Array.isArray(i.messages)&&i.messages.forEach((c,l)=>{c.role==="user"&&c.content&&(console.log(`
ðŸ“¨ User message (${c.content.length} chars):`),console.log(c.content),console.log(`
`))})),a&&a.runtime&&(async()=>{try{const c=await a.runtime.sendMessage({type:"API_REQUEST",method:r,endpoint:s,body:i});c.error&&console.log("âŒ [SPEEDY] Error:",c.error),window.postMessage({type:"SPEEDY_API_RESPONSE",requestId:o,success:c.success,data:c.data,error:c.error},"*")}catch(c){console.error("âŒ [SPEEDY] API request failed:",c),window.postMessage({type:"SPEEDY_API_RESPONSE",requestId:o,success:!1,error:c.message||"API request failed"},"*")}})()}if(e.data.type==="SPEEDY_CAPTURE_SCREENSHOT"){const{requestId:o}=e.data;a&&a.runtime&&(async()=>{try{const r=await a.runtime.sendMessage({type:"CAPTURE_SCREENSHOT"});window.postMessage({type:"SPEEDY_SCREENSHOT_RESPONSE",requestId:o,success:r.success,dataUrl:r.dataUrl,error:r.error},"*")}catch(r){window.postMessage({type:"SPEEDY_SCREENSHOT_RESPONSE",requestId:o,success:!1,error:r.message||"Screenshot capture failed"},"*")}})()}if(e.data.type==="SPEEDY_EXTRACT_TAB_CONTENT"){const{requestId:o,tabId:r}=e.data;a&&a.runtime&&(async()=>{try{const s=await a.runtime.sendMessage({type:"EXTRACT_TAB_CONTENT",tabId:r});window.postMessage({type:"SPEEDY_EXTRACT_RESPONSE",requestId:o,success:s.success,content:s.content,error:s.error},"*")}catch(s){console.error("âŒ [SPEEDY] Tab content extraction failed:",s),window.postMessage({type:"SPEEDY_EXTRACT_RESPONSE",requestId:o,success:!1,error:s.message||"Content extraction failed"},"*")}})()}if(e.data.type==="SPEEDY_GET_OVERLAY_STATE"&&(console.log("ðŸ“¥ [Content] Received SPEEDY_GET_OVERLAY_STATE request"),a&&a.storage?a.storage.local.get(["overlayState"],o=>{console.log("ðŸ“¤ [Content] Retrieved overlay state from storage:",o.overlayState);const r=o.overlayState||{isVisible:!1};console.log("ðŸ“¤ [Content] Sending state response:",r),window.postMessage({type:"SPEEDY_OVERLAY_STATE_RESPONSE",state:r},"*")}):console.error("âŒ [Content] browser.storage not available")),e.data.type==="SPEEDY_SAVE_OVERLAY_STATE"){const o=e.data.isVisible;if(console.log("ðŸ’¾ [Content] Received SPEEDY_SAVE_OVERLAY_STATE request:",o),a&&a.storage){const r={overlayState:{isVisible:o,timestamp:Date.now()}};console.log("ðŸ’¾ [Content] Saving to storage:",r),a.storage.local.set(r,()=>{console.log("âœ… [Content] State saved successfully")})}else console.error("âŒ [Content] browser.storage not available")}}}),a&&a.storage?(console.log("ðŸ‘‚ [Content] Setting up storage change listener"),a.storage.onChanged.addListener((e,o)=>{console.log("ðŸ”” [Content] Storage changed:",o,e),o==="local"&&e.overlayState&&(console.log("ðŸ”” [Content] overlayState changed:",e.overlayState),console.log("ðŸ”” [Content] New value:",e.overlayState.newValue),console.log("ðŸ”” [Content] Old value:",e.overlayState.oldValue),window.postMessage({type:"SPEEDY_OVERLAY_STATE_CHANGED",state:e.overlayState.newValue},"*"),console.log("ðŸ“¢ [Content] Broadcasted state change to overlay"))})):console.error("âŒ [Content] browser.storage not available for listener"),typeof window.__speedyAiInitialized>"u"){let e=function(){console.log("ðŸš€ [Content] ===== SPEEDY AI CONTENT SCRIPT LOADED ====="),console.log("ðŸš€ [Content] URL:",window.location.href),console.log("ðŸš€ [Content] Timestamp:",new Date().toISOString()),b(),t(),console.log("âœ… [Content] Initialization complete")};var v=e;window.__speedyAiInitialized=!0,typeof document<"u"&&document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):typeof document<"u"&&e()}else console.log("â­ï¸ Speedy AI Content Script already initialized, skipping")}
